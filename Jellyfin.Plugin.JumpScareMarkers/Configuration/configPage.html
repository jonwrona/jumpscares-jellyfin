<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jump Scare Markers</title>
</head>
<body>
    <div id="JumpScareMarkersConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JumpScareMarkersConfigForm">
                    <h2>Segment Delta Configuration</h2>
                    <p>Configure how timeline segments are created from jump scare timestamps.</p>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="StartDeltaSeconds">Start Delta (seconds)</label>
                        <input id="StartDeltaSeconds" name="StartDeltaSeconds" type="number" is="emby-input" />
                        <div class="fieldDescription">Seconds before the timestamp to start the segment (use negative value, e.g., -2)</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="EndDeltaSeconds">End Delta (seconds)</label>
                        <input id="EndDeltaSeconds" name="EndDeltaSeconds" type="number" is="emby-input" />
                        <div class="fieldDescription">Seconds after the timestamp to end the segment (e.g., 2)</div>
                    </div>

                    <h2>notscare.me Integration</h2>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="NotScareApiUrl">API URL</label>
                        <input id="NotScareApiUrl" name="NotScareApiUrl" type="text" is="emby-input" />
                        <div class="fieldDescription">notscare.me API endpoint URL</div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableNotScareSync" name="EnableNotScareSync" type="checkbox" is="emby-checkbox" />
                            <span>Enable automatic sync with notscare.me</span>
                        </label>
                        <div class="fieldDescription">Automatically sync jump scare data from notscare.me (requires API access)</div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save Configuration</span>
                        </button>
                    </div>
                </form>

                <h2 style="margin-top: 2em;">Import Jump Scare Data</h2>
                <p>Upload a CSV file containing jump scare timestamps.</p>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="csvFileInput">CSV File</label>
                    <input type="file" id="csvFileInput" accept=".csv" style="max-width: 400px;" />
                    <div class="fieldDescription">Expected format: ItemName,IMDb,TMDb,Timestamp,Intensity,Description,Type</div>
                </div>

                <div style="margin-top: 1em;">
                    <button is="emby-button" id="importButton" class="raised button-submit emby-button">
                        <span>Import CSV</span>
                    </button>
                    <button is="emby-button" id="clearButton" class="raised emby-button" style="margin-left: 1em;">
                        <span>Clear All Data</span>
                    </button>
                </div>

                <div id="importResult" style="margin-top: 1em;"></div>

                <h2 style="margin-top: 2em;">Database Statistics</h2>
                <div id="statistics" style="padding: 1em; background: rgba(255,255,255,0.05); border-radius: 4px;">
                    <p>Loading statistics...</p>
                </div>

                <h2 style="margin-top: 2em;">Current Jump Scares</h2>
                <div id="jumpScareList" style="max-height: 400px; overflow-y: auto;">
                    <p>Loading jump scares...</p>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            var JumpScareMarkersConfig = {
                pluginUniqueId: '4a2f8b1c-6d3e-4f9a-b5c7-8e0d2f3a4b5c'
            };

            // Load statistics
            function loadStatistics() {
                var url = ApiClient.getUrl('/JumpScareMarkers/Statistics');
                var accessToken = ApiClient.accessToken();
                if (accessToken) {
                    url += (url.indexOf('?') === -1 ? '?' : '&') + 'api_key=' + accessToken;
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return response.json();
                    })
                    .then(stats => {
                        var html = '<p><strong>Total Jump Scares:</strong> ' + stats.TotalScares + '</p>';
                        html += '<p><strong>Items with Scares:</strong> ' + stats.TotalItems + '</p>';
                        html += '<p><strong>Major Scares:</strong> ' + stats.MajorScares + '</p>';
                        html += '<p><strong>Minor Scares:</strong> ' + stats.MinorScares + '</p>';
                        document.querySelector('#statistics').innerHTML = html;
                    })
                    .catch(error => {
                        document.querySelector('#statistics').innerHTML = '<p style="color: red;">Error loading statistics</p>';
                    });
            }

            // Load jump scare list
            function loadJumpScares() {
                var url = ApiClient.getUrl('/JumpScareMarkers/All');
                var accessToken = ApiClient.accessToken();
                if (accessToken) {
                    url += (url.indexOf('?') === -1 ? '?' : '&') + 'api_key=' + accessToken;
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return response.json();
                    })
                    .then(scares => {
                        if (scares.length === 0) {
                            document.querySelector('#jumpScareList').innerHTML = '<p>No jump scares imported yet.</p>';
                            return;
                        }

                        var html = '<table class="tblConnections" style="width: 100%;">';
                        html += '<thead><tr><th>Item</th><th>Time</th><th>Intensity</th><th>Type</th><th>Description</th></tr></thead>';
                        html += '<tbody>';

                        scares.forEach(function(scare) {
                            var seconds = scare.TimestampTicks / 10000000;
                            var hours = Math.floor(seconds / 3600);
                            var minutes = Math.floor((seconds % 3600) / 60);
                            var secs = Math.floor(seconds % 60);
                            var timeStr = hours > 0 ?
                                hours + ':' + String(minutes).padStart(2, '0') + ':' + String(secs).padStart(2, '0') :
                                minutes + ':' + String(secs).padStart(2, '0');

                            html += '<tr>';
                            html += '<td>' + (scare.ItemName || 'Unknown') + '</td>';
                            html += '<td>' + timeStr + '</td>';
                            html += '<td>' + (scare.Intensity || 'N/A') + '</td>';
                            html += '<td>' + (scare.Type || 'N/A') + '</td>';
                            html += '<td>' + (scare.Description || '') + '</td>';
                            html += '</tr>';
                        });

                        html += '</tbody></table>';
                        document.querySelector('#jumpScareList').innerHTML = html;
                    })
                    .catch(error => {
                        document.querySelector('#jumpScareList').innerHTML = '<p style="color: red;">Error loading jump scares</p>';
                    });
            }

            document.querySelector('#JumpScareMarkersConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JumpScareMarkersConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#StartDeltaSeconds').value = config.StartDeltaSeconds;
                        document.querySelector('#EndDeltaSeconds').value = config.EndDeltaSeconds;
                        document.querySelector('#NotScareApiUrl').value = config.NotScareApiUrl;
                        document.querySelector('#EnableNotScareSync').checked = config.EnableNotScareSync;
                        Dashboard.hideLoadingMsg();

                        // Load data
                        loadStatistics();
                        loadJumpScares();
                    });
                });

            document.querySelector('#JumpScareMarkersConfigForm')
                .addEventListener('submit', function(e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(JumpScareMarkersConfig.pluginUniqueId).then(function (config) {
                    config.StartDeltaSeconds = parseInt(document.querySelector('#StartDeltaSeconds').value);
                    config.EndDeltaSeconds = parseInt(document.querySelector('#EndDeltaSeconds').value);
                    config.NotScareApiUrl = document.querySelector('#NotScareApiUrl').value;
                    config.EnableNotScareSync = document.querySelector('#EnableNotScareSync').checked;
                    ApiClient.updatePluginConfiguration(JumpScareMarkersConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });

                e.preventDefault();
                return false;
            });

            // Import CSV handler
            document.querySelector('#importButton').addEventListener('click', async function() {
                var fileInput = document.querySelector('#csvFileInput');
                var file = fileInput.files[0];

                if (!file) {
                    Dashboard.alert('Please select a CSV file to import');
                    return;
                }

                var formData = new FormData();
                formData.append('file', file);

                try {
                    Dashboard.showLoadingMsg();

                    // Build request with authentication token
                    var url = ApiClient.getUrl('/JumpScareMarkers/Import');
                    var accessToken = ApiClient.accessToken();

                    if (accessToken) {
                        url += (url.indexOf('?') === -1 ? '?' : '&') + 'api_key=' + accessToken;
                    }

                    var response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        var errorText = await response.text();
                        throw new Error('HTTP ' + response.status + ': ' + (errorText || response.statusText));
                    }

                    var result = await response.json();

                    var resultHtml = result.Success ?
                        '<p style="color: #52b54b; font-weight: bold;">' + result.Message + '</p>' +
                        '<p>Total Rows: ' + result.TotalRows + '</p>' +
                        '<p>Imported: ' + result.ImportedCount + '</p>' +
                        '<p>Skipped: ' + result.SkippedCount + '</p>' :
                        '<p style="color: #cc3333; font-weight: bold;">' + result.Message + '</p>';

                    document.querySelector('#importResult').innerHTML = resultHtml;

                    if (result.Success) {
                        // Reload data
                        loadStatistics();
                        loadJumpScares();
                        fileInput.value = ''; // Clear file input
                    }

                    Dashboard.hideLoadingMsg();
                } catch (error) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Import failed: ' + error.message);
                }
            });

            // Clear all data handler
            document.querySelector('#clearButton').addEventListener('click', function() {
                Dashboard.confirm('Are you sure you want to clear all jump scare data? This cannot be undone.', 'Confirm Clear', async function(confirmed) {
                    if (!confirmed) return;

                    try {
                        Dashboard.showLoadingMsg();

                        var url = ApiClient.getUrl('/JumpScareMarkers/All');
                        var accessToken = ApiClient.accessToken();
                        if (accessToken) {
                            url += (url.indexOf('?') === -1 ? '?' : '&') + 'api_key=' + accessToken;
                        }

                        var response = await fetch(url, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                        }

                        var result = await response.json();

                        if (result.success) {
                            Dashboard.alert(result.message);
                            loadStatistics();
                            loadJumpScares();
                        } else {
                            Dashboard.alert('Failed to clear data: ' + result.message);
                        }

                        Dashboard.hideLoadingMsg();
                    } catch (error) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Error: ' + error.message);
                    }
                });
            });
        </script>
    </div>
</body>
</html>
